"use strict";
/**
 * StoryForge - Shared Utilities
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.groupBy = exports.unique = exports.chunk = exports.omit = exports.pick = exports.deepClone = exports.sleep = exports.getBackoffDelay = exports.getRelativeTime = exports.formatDuration = exports.sanitizeInput = exports.isValidUsername = exports.isValidEmail = exports.generateUniqueSlug = exports.generateSlug = exports.generateLocationId = exports.generateCharacterId = exports.generateIdempotencyKey = exports.generateId = void 0;
const uuid_1 = require("uuid");
// ============================================================================
// ID GENERATION
// ============================================================================
const NAMESPACE_UUID = '6ba7b810-9dad-11d1-80b4-00c04fd430c8';
/**
 * Generate a random UUID v4
 */
const generateId = () => (0, uuid_1.v4)();
exports.generateId = generateId;
/**
 * Generate a deterministic UUID v5 for idempotency
 */
const generateIdempotencyKey = (userId, sceneId, timestamp) => {
    return (0, uuid_1.v5)(`${userId}:${sceneId}:${timestamp}`, NAMESPACE_UUID);
};
exports.generateIdempotencyKey = generateIdempotencyKey;
/**
 * Generate a character ID (stable within a scene)
 */
const generateCharacterId = (sceneId, characterName) => {
    const normalized = characterName.toLowerCase().trim().replace(/\s+/g, '_');
    return (0, uuid_1.v5)(`${sceneId}:char:${normalized}`, NAMESPACE_UUID);
};
exports.generateCharacterId = generateCharacterId;
/**
 * Generate a location ID (stable within a scene)
 */
const generateLocationId = (sceneId, locationName) => {
    const normalized = locationName.toLowerCase().trim().replace(/\s+/g, '_');
    return (0, uuid_1.v5)(`${sceneId}:loc:${normalized}`, NAMESPACE_UUID);
};
exports.generateLocationId = generateLocationId;
// ============================================================================
// SLUG GENERATION
// ============================================================================
/**
 * Generate URL-safe slug from text
 */
const generateSlug = (text) => {
    return text
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .substring(0, 100);
};
exports.generateSlug = generateSlug;
/**
 * Generate unique slug with random suffix
 */
const generateUniqueSlug = (text) => {
    const base = (0, exports.generateSlug)(text);
    const suffix = (0, exports.generateId)().substring(0, 8);
    return `${base}-${suffix}`;
};
exports.generateUniqueSlug = generateUniqueSlug;
// ============================================================================
// VALIDATION HELPERS
// ============================================================================
/**
 * Validate email format
 */
const isValidEmail = (email) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
};
exports.isValidEmail = isValidEmail;
/**
 * Validate username format
 */
const isValidUsername = (username) => {
    const usernameRegex = /^[a-zA-Z0-9_]{3,30}$/;
    return usernameRegex.test(username);
};
exports.isValidUsername = isValidUsername;
/**
 * Sanitize user input
 */
const sanitizeInput = (input) => {
    return input
        .trim()
        .replace(/<[^>]*>/g, '') // Remove HTML tags
        .substring(0, 10000); // Limit length
};
exports.sanitizeInput = sanitizeInput;
// ============================================================================
// DATE HELPERS
// ============================================================================
/**
 * Format duration in milliseconds to human-readable
 */
const formatDuration = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    if (hours > 0) {
        return `${hours}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
    }
    return `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
};
exports.formatDuration = formatDuration;
/**
 * Get relative time string
 */
const getRelativeTime = (date) => {
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffSeconds = Math.floor(diffMs / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffSeconds < 60)
        return 'just now';
    if (diffMinutes < 60)
        return `${diffMinutes}m ago`;
    if (diffHours < 24)
        return `${diffHours}h ago`;
    if (diffDays < 7)
        return `${diffDays}d ago`;
    return date.toLocaleDateString();
};
exports.getRelativeTime = getRelativeTime;
// ============================================================================
// RETRY HELPERS
// ============================================================================
/**
 * Calculate exponential backoff delay
 */
const getBackoffDelay = (attempt, baseDelay = 1000, maxDelay = 30000) => {
    const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);
    // Add jitter (Â±20%)
    const jitter = delay * 0.2 * (Math.random() - 0.5);
    return Math.floor(delay + jitter);
};
exports.getBackoffDelay = getBackoffDelay;
/**
 * Sleep for specified milliseconds
 */
const sleep = (ms) => {
    return new Promise((resolve) => setTimeout(resolve, ms));
};
exports.sleep = sleep;
// ============================================================================
// OBJECT HELPERS
// ============================================================================
/**
 * Deep clone an object
 */
const deepClone = (obj) => {
    return JSON.parse(JSON.stringify(obj));
};
exports.deepClone = deepClone;
/**
 * Pick specific keys from an object
 */
const pick = (obj, keys) => {
    const result = {};
    keys.forEach((key) => {
        if (key in obj) {
            result[key] = obj[key];
        }
    });
    return result;
};
exports.pick = pick;
/**
 * Omit specific keys from an object
 */
const omit = (obj, keys) => {
    const result = { ...obj };
    keys.forEach((key) => {
        delete result[key];
    });
    return result;
};
exports.omit = omit;
// ============================================================================
// ARRAY HELPERS
// ============================================================================
/**
 * Chunk array into smaller arrays
 */
const chunk = (array, size) => {
    const chunks = [];
    for (let i = 0; i < array.length; i += size) {
        chunks.push(array.slice(i, i + size));
    }
    return chunks;
};
exports.chunk = chunk;
/**
 * Remove duplicates from array
 */
const unique = (array) => {
    return [...new Set(array)];
};
exports.unique = unique;
/**
 * Group array by key
 */
const groupBy = (array, keyFn) => {
    return array.reduce((acc, item) => {
        const key = keyFn(item);
        if (!acc[key]) {
            acc[key] = [];
        }
        acc[key].push(item);
        return acc;
    }, {});
};
exports.groupBy = groupBy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOzs7QUFFSCwrQkFBa0Q7QUFFbEQsK0VBQStFO0FBQy9FLGdCQUFnQjtBQUNoQiwrRUFBK0U7QUFFL0UsTUFBTSxjQUFjLEdBQUcsc0NBQXNDLENBQUM7QUFFOUQ7O0dBRUc7QUFDSSxNQUFNLFVBQVUsR0FBRyxHQUFXLEVBQUUsQ0FBQyxJQUFBLFNBQU0sR0FBRSxDQUFDO0FBQXBDLFFBQUEsVUFBVSxjQUEwQjtBQUVqRDs7R0FFRztBQUNJLE1BQU0sc0JBQXNCLEdBQUcsQ0FDcEMsTUFBYyxFQUNkLE9BQWUsRUFDZixTQUFpQixFQUNULEVBQUU7SUFDVixPQUFPLElBQUEsU0FBTSxFQUFDLEdBQUcsTUFBTSxJQUFJLE9BQU8sSUFBSSxTQUFTLEVBQUUsRUFBRSxjQUFjLENBQUMsQ0FBQztBQUNyRSxDQUFDLENBQUM7QUFOVyxRQUFBLHNCQUFzQiwwQkFNakM7QUFFRjs7R0FFRztBQUNJLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxPQUFlLEVBQUUsYUFBcUIsRUFBVSxFQUFFO0lBQ3BGLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzNFLE9BQU8sSUFBQSxTQUFNLEVBQUMsR0FBRyxPQUFPLFNBQVMsVUFBVSxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUM7QUFDakUsQ0FBQyxDQUFDO0FBSFcsUUFBQSxtQkFBbUIsdUJBRzlCO0FBRUY7O0dBRUc7QUFDSSxNQUFNLGtCQUFrQixHQUFHLENBQUMsT0FBZSxFQUFFLFlBQW9CLEVBQVUsRUFBRTtJQUNsRixNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLE1B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SSxLQUFVLEVBQU8sRUFBRTtJQUMzQyxPQUFPLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQzdCLENBQUMsQ0FBQztBQUZXLFFBQUEsTUFBTSxVQUVqQjtBQUVGOztHQUVHO0FBQ0ksTUFBTSxPQUFPLEdBQUcsQ0FDckIsS0FBVSxFQUNWLEtBQXFCLEVBQ0wsRUFBRTtJQUNsQixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDaEMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNkLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDaEIsQ0FBQztRQUNELEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEIsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDLEVBQUUsRUFBb0IsQ0FBQyxDQUFDO0FBQzNCLENBQUMsQ0FBQztBQVpXLFFBQUEsT0FBTyxXQVlsQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3RvcnlGb3JnZSAtIFNoYXJlZCBVdGlsaXRpZXNcbiAqL1xuXG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQsIHY1IGFzIHV1aWR2NSB9IGZyb20gJ3V1aWQnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBJRCBHRU5FUkFUSU9OXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IE5BTUVTUEFDRV9VVUlEID0gJzZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7XG5cbi8qKlxuICogR2VuZXJhdGUgYSByYW5kb20gVVVJRCB2NFxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVJZCA9ICgpOiBzdHJpbmcgPT4gdXVpZHY0KCk7XG5cbi8qKlxuICogR2VuZXJhdGUgYSBkZXRlcm1pbmlzdGljIFVVSUQgdjUgZm9yIGlkZW1wb3RlbmN5XG4gKi9cbmV4cG9ydCBjb25zdCBnZW5lcmF0ZUlkZW1wb3RlbmN5S2V5ID0gKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgc2NlbmVJZDogc3RyaW5nLFxuICB0aW1lc3RhbXA6IG51bWJlclxuKTogc3RyaW5nID0+IHtcbiAgcmV0dXJuIHV1aWR2NShgJHt1c2VySWR9OiR7c2NlbmVJZH06JHt0aW1lc3RhbXB9YCwgTkFNRVNQQUNFX1VVSUQpO1xufTtcblxuLyoqXG4gKiBHZW5lcmF0ZSBhIGNoYXJhY3RlciBJRCAoc3RhYmxlIHdpdGhpbiBhIHNjZW5lKVxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVDaGFyYWN0ZXJJZCA9IChzY2VuZUlkOiBzdHJpbmcsIGNoYXJhY3Rlck5hbWU6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIGNvbnN0IG5vcm1hbGl6ZWQgPSBjaGFyYWN0ZXJOYW1lLnRvTG93ZXJDYXNlKCkudHJpbSgpLnJlcGxhY2UoL1xccysvZywgJ18nKTtcbiAgcmV0dXJuIHV1aWR2NShgJHtzY2VuZUlkfTpjaGFyOiR7bm9ybWFsaXplZH1gLCBOQU1FU1BBQ0VfVVVJRCk7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlIGEgbG9jYXRpb24gSUQgKHN0YWJsZSB3aXRoaW4gYSBzY2VuZSlcbiAqL1xuZXhwb3J0IGNvbnN0IGdlbmVyYXRlTG9jYXRpb25JZCA9IChzY2VuZUlkOiBzdHJpbmcsIGxvY2F0aW9uTmFtZTogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgY29uc3Qgbm9ybWFsaXplZCA9IGxvY2F0aW9uTmFtZS50b0xvd2VyQ2FzZSgpLnRyaW0oKS5yZXBsYWNlKC9cXHMrL2csICdfJyk7XG4gIHJldHVybiB1dWlkdjUoYCR7c2NlbmVJZH06bG9jOiR7bm9ybWFsaXplZH1gLCBOQU1FU1BBQ0VfVVVJRCk7XG59O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBTTFVHIEdFTkVSQVRJT05cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBHZW5lcmF0ZSBVUkwtc2FmZSBzbHVnIGZyb20gdGV4dFxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVTbHVnID0gKHRleHQ6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIHJldHVybiB0ZXh0XG4gICAgLnRvTG93ZXJDYXNlKClcbiAgICAudHJpbSgpXG4gICAgLnJlcGxhY2UoL1teXFx3XFxzLV0vZywgJycpXG4gICAgLnJlcGxhY2UoL1tcXHNfLV0rL2csICctJylcbiAgICAucmVwbGFjZSgvXi0rfC0rJC9nLCAnJylcbiAgICAuc3Vic3RyaW5nKDAsIDEwMCk7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlIHVuaXF1ZSBzbHVnIHdpdGggcmFuZG9tIHN1ZmZpeFxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVVbmlxdWVTbHVnID0gKHRleHQ6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIGNvbnN0IGJhc2UgPSBnZW5lcmF0ZVNsdWcodGV4dCk7XG4gIGNvbnN0IHN1ZmZpeCA9IGdlbmVyYXRlSWQoKS5zdWJzdHJpbmcoMCwgOCk7XG4gIHJldHVybiBgJHtiYXNlfS0ke3N1ZmZpeH1gO1xufTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVkFMSURBVElPTiBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogVmFsaWRhdGUgZW1haWwgZm9ybWF0XG4gKi9cbmV4cG9ydCBjb25zdCBpc1ZhbGlkRW1haWwgPSAoZW1haWw6IHN0cmluZyk6IGJvb2xlYW4gPT4ge1xuICBjb25zdCBlbWFpbFJlZ2V4ID0gL15bXlxcc0BdK0BbXlxcc0BdK1xcLlteXFxzQF0rJC87XG4gIHJldHVybiBlbWFpbFJlZ2V4LnRlc3QoZW1haWwpO1xufTtcblxuLyoqXG4gKiBWYWxpZGF0ZSB1c2VybmFtZSBmb3JtYXRcbiAqL1xuZXhwb3J0IGNvbnN0IGlzVmFsaWRVc2VybmFtZSA9ICh1c2VybmFtZTogc3RyaW5nKTogYm9vbGVhbiA9PiB7XG4gIGNvbnN0IHVzZXJuYW1lUmVnZXggPSAvXlthLXpBLVowLTlfXXszLDMwfSQvO1xuICByZXR1cm4gdXNlcm5hbWVSZWdleC50ZXN0KHVzZXJuYW1lKTtcbn07XG5cbi8qKlxuICogU2FuaXRpemUgdXNlciBpbnB1dFxuICovXG5leHBvcnQgY29uc3Qgc2FuaXRpemVJbnB1dCA9IChpbnB1dDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgcmV0dXJuIGlucHV0XG4gICAgLnRyaW0oKVxuICAgIC5yZXBsYWNlKC88W14+XSo+L2csICcnKSAvLyBSZW1vdmUgSFRNTCB0YWdzXG4gICAgLnN1YnN0cmluZygwLCAxMDAwMCk7IC8vIExpbWl0IGxlbmd0aFxufTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gREFURSBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogRm9ybWF0IGR1cmF0aW9uIGluIG1pbGxpc2Vjb25kcyB0byBodW1hbi1yZWFkYWJsZVxuICovXG5leHBvcnQgY29uc3QgZm9ybWF0RHVyYXRpb24gPSAobXM6IG51bWJlcik6IHN0cmluZyA9PiB7XG4gIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKG1zIC8gMTAwMCk7XG4gIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHNlY29uZHMgLyA2MCk7XG4gIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihtaW51dGVzIC8gNjApO1xuXG4gIGlmIChob3VycyA+IDApIHtcbiAgICByZXR1cm4gYCR7aG91cnN9OiR7KG1pbnV0ZXMgJSA2MCkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfTokeyhzZWNvbmRzICUgNjApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gO1xuICB9XG4gIHJldHVybiBgJHttaW51dGVzfTokeyhzZWNvbmRzICUgNjApLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgJzAnKX1gO1xufTtcblxuLyoqXG4gKiBHZXQgcmVsYXRpdmUgdGltZSBzdHJpbmdcbiAqL1xuZXhwb3J0IGNvbnN0IGdldFJlbGF0aXZlVGltZSA9IChkYXRlOiBEYXRlKTogc3RyaW5nID0+IHtcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgY29uc3QgZGlmZk1zID0gbm93LmdldFRpbWUoKSAtIGRhdGUuZ2V0VGltZSgpO1xuICBjb25zdCBkaWZmU2Vjb25kcyA9IE1hdGguZmxvb3IoZGlmZk1zIC8gMTAwMCk7XG4gIGNvbnN0IGRpZmZNaW51dGVzID0gTWF0aC5mbG9vcihkaWZmU2Vjb25kcyAvIDYwKTtcbiAgY29uc3QgZGlmZkhvdXJzID0gTWF0aC5mbG9vcihkaWZmTWludXRlcyAvIDYwKTtcbiAgY29uc3QgZGlmZkRheXMgPSBNYXRoLmZsb29yKGRpZmZIb3VycyAvIDI0KTtcblxuICBpZiAoZGlmZlNlY29uZHMgPCA2MCkgcmV0dXJuICdqdXN0IG5vdyc7XG4gIGlmIChkaWZmTWludXRlcyA8IDYwKSByZXR1cm4gYCR7ZGlmZk1pbnV0ZXN9bSBhZ29gO1xuICBpZiAoZGlmZkhvdXJzIDwgMjQpIHJldHVybiBgJHtkaWZmSG91cnN9aCBhZ29gO1xuICBpZiAoZGlmZkRheXMgPCA3KSByZXR1cm4gYCR7ZGlmZkRheXN9ZCBhZ29gO1xuICByZXR1cm4gZGF0ZS50b0xvY2FsZURhdGVTdHJpbmcoKTtcbn07XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFJFVFJZIEhFTFBFUlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBDYWxjdWxhdGUgZXhwb25lbnRpYWwgYmFja29mZiBkZWxheVxuICovXG5leHBvcnQgY29uc3QgZ2V0QmFja29mZkRlbGF5ID0gKFxuICBhdHRlbXB0OiBudW1iZXIsXG4gIGJhc2VEZWxheTogbnVtYmVyID0gMTAwMCxcbiAgbWF4RGVsYXk6IG51bWJlciA9IDMwMDAwXG4pOiBudW1iZXIgPT4ge1xuICBjb25zdCBkZWxheSA9IE1hdGgubWluKGJhc2VEZWxheSAqIE1hdGgucG93KDIsIGF0dGVtcHQpLCBtYXhEZWxheSk7XG4gIC8vIEFkZCBqaXR0ZXIgKMKxMjAlKVxuICBjb25zdCBqaXR0ZXIgPSBkZWxheSAqIDAuMiAqIChNYXRoLnJhbmRvbSgpIC0gMC41KTtcbiAgcmV0dXJuIE1hdGguZmxvb3IoZGVsYXkgKyBqaXR0ZXIpO1xufTtcblxuLyoqXG4gKiBTbGVlcCBmb3Igc3BlY2lmaWVkIG1pbGxpc2Vjb25kc1xuICovXG5leHBvcnQgY29uc3Qgc2xlZXAgPSAobXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4gPT4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcbn07XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIE9CSkVDVCBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogRGVlcCBjbG9uZSBhbiBvYmplY3RcbiAqL1xuZXhwb3J0IGNvbnN0IGRlZXBDbG9uZSA9IDxUPihvYmo6IFQpOiBUID0+IHtcbiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7XG59O1xuXG4vKipcbiAqIFBpY2sgc3BlY2lmaWMga2V5cyBmcm9tIGFuIG9iamVjdFxuICovXG5leHBvcnQgY29uc3QgcGljayA9IDxUIGV4dGVuZHMgb2JqZWN0LCBLIGV4dGVuZHMga2V5b2YgVD4oXG4gIG9iajogVCxcbiAga2V5czogS1tdXG4pOiBQaWNrPFQsIEs+ID0+IHtcbiAgY29uc3QgcmVzdWx0ID0ge30gYXMgUGljazxULCBLPjtcbiAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBpZiAoa2V5IGluIG9iaikge1xuICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBPbWl0IHNwZWNpZmljIGtleXMgZnJvbSBhbiBvYmplY3RcbiAqL1xuZXhwb3J0IGNvbnN0IG9taXQgPSA8VCBleHRlbmRzIG9iamVjdCwgSyBleHRlbmRzIGtleW9mIFQ+KFxuICBvYmo6IFQsXG4gIGtleXM6IEtbXVxuKTogT21pdDxULCBLPiA9PiB7XG4gIGNvbnN0IHJlc3VsdCA9IHsgLi4ub2JqIH07XG4gIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgZGVsZXRlIHJlc3VsdFtrZXldO1xuICB9KTtcbiAgcmV0dXJuIHJlc3VsdCBhcyBPbWl0PFQsIEs+O1xufTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gQVJSQVkgSEVMUEVSU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIENodW5rIGFycmF5IGludG8gc21hbGxlciBhcnJheXNcbiAqL1xuZXhwb3J0IGNvbnN0IGNodW5rID0gPFQ+KGFycmF5OiBUW10sIHNpemU6IG51bWJlcik6IFRbXVtdID0+IHtcbiAgY29uc3QgY2h1bmtzOiBUW11bXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBzaXplKSB7XG4gICAgY2h1bmtzLnB1c2goYXJyYXkuc2xpY2UoaSwgaSArIHNpemUpKTtcbiAgfVxuICByZXR1cm4gY2h1bmtzO1xufTtcblxuLyoqXG4gKiBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIGFycmF5XG4gKi9cbmV4cG9ydCBjb25zdCB1bmlxdWUgPSA8VD4oYXJyYXk6IFRbXSk6IFRbXSA9PiB7XG4gIHJldHVybiBbLi4ubmV3IFNldChhcnJheSldO1xufTtcblxuLyoqXG4gKiBHcm91cCBhcnJheSBieSBrZXlcbiAqL1xuZXhwb3J0IGNvbnN0IGdyb3VwQnkgPSA8VCwgSyBleHRlbmRzIHN0cmluZyB8IG51bWJlcj4oXG4gIGFycmF5OiBUW10sXG4gIGtleUZuOiAoaXRlbTogVCkgPT4gS1xuKTogUmVjb3JkPEssIFRbXT4gPT4ge1xuICByZXR1cm4gYXJyYXkucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICBjb25zdCBrZXkgPSBrZXlGbihpdGVtKTtcbiAgICBpZiAoIWFjY1trZXldKSB7XG4gICAgICBhY2Nba2V5XSA9IFtdO1xuICAgIH1cbiAgICBhY2Nba2V5XS5wdXNoKGl0ZW0pO1xuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9IGFzIFJlY29yZDxLLCBUW10+KTtcbn07XG4iXX0=